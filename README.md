# Oral Disease Detection Model

## Model Overview
This repository hosts the training pipeline for a production-grade Oral Disease Detection system. The model is built on the Faster R-CNN architecture (ResNet-50 backbone) and is designed to detect and classify dental abnormalities from standard photographic inputs.

## Training Configuration
- **Architecture:** Faster R-CNN (ResNet-50-FPN) with ImageNet pre-trained weights
- **Training Strategy:** Transfer learning with validation-based model selection
- **Data Split:** 64% training, 16% validation, 20% test
- **Epochs:** 50 (with early stopping after 10 epochs without improvement)
- **Optimization:** SGD (Learning Rate: 0.005, Momentum: 0.9, Weight Decay: 0.0005)
- **Learning Rate Scheduling:** ReduceLROnPlateau (reduces LR by 50% when validation loss plateaus)
- **Class Handling:** 20-class capacity buffer to ensure scalability

## Usage
**Do not manually populate the `raw_data/` directory.** This directory is automatically generated by the data processing pipeline to ensure consistent formatting and file integrity.

### Quick Start
1. **Build the Dataset:** Follow the **Setup Instructions** below to download sources and generate the training/validation/test splits.
2. **Train the Model:** 
   - **HPC (Oregon State):** Submit job via SLURM: `sbatch submit_job.sh`
   - **Local:** Run `python train_pytorch.py`
3. **Monitor Training:** Track progress in the logs:
   ```bash
   tail -f logs/training_run_log.txt
   ```
4. **Evaluate Model:** After training, evaluate on the test set:
   ```bash
   python evaluate_model.py
   ```
   The best model (based on validation loss) is automatically saved as `production_models/oral_model_v1_best.pth`.

**Note:** `submit_job.sh` is configured for Oregon State HPC. Modify it for other HPC systems or run training locally.

## Setup Instructions
To reproduce the dataset creation and training pipeline from scratch, execute the following commands in order:

### 1. Environment Setup
```bash
python -m venv venv (Mac/Linux)
OR
py -m venv venv (Win)
```

```bash
pip install -r requirements.txt (Ensure that the venv is active)
```

### 2. Data Acquisition
Before running any scripts, you must manually download the required datasets listed in the **Datasets** section below.
1. Download the zip files from the provided Roboflow and Zenodo links.
2. Extract the contents of each dataset into the `downloads/` directory (or the specific input folder expected by `load_datasets.py`).

### 3. Data Pipeline Execution
Once the raw datasets are in place, run the processing scripts in this exact order:

* **Step 1**
  Validates downloaded files and organizes them for processing.
  ```bash
  python load_datasets.py (Mac/Linux)
  OR
  py load_datasets.py (Win)
  ```

* **Step 2**
  Removes invalid annotations, maps class labels (e.g., 'caries' -> Class 1), and cleans metadata.
  ```bash
  python filter_classes.py (Mac/Linux)
  OR
  py filter_classes.py (Win)
  ```

* **Step 3**
  Builds the final `raw_data/` directory structure required by the model.
  ```bash
  python build.py (Mac/Linux)
  OR
  py build.py (Win)
  ```

* **Step 4**
  Scans `raw_data/` and generates train/validation/test splits (64/16/20).
  Creates `train_list.txt`, `val_list.txt`, and `test_list.txt`.
  ```bash
  python create_dataset.py (Mac/Linux)
  OR
  py create_dataset.py (Win)
  ```

### 4. Training
Train the model with validation loop and early stopping:
```bash
python train_pytorch.py
```

The training script will:
- Train on 64% of the data
- Validate on 16% of the data after each epoch
- Automatically save the best model based on validation loss
- Apply learning rate scheduling when validation loss plateaus
- Stop early if no improvement for 10 epochs

### 5. Evaluation
Evaluate the trained model on the held-out test set:
```bash
python evaluate_model.py
```

This will:
- Load the best model (`oral_model_v1_best.pth`)
- Evaluate on the 20% test set
- Calculate mAP (mean Average Precision) and per-class metrics
- Save results to `logs/evaluation_results.json`

## Datasets
The model is trained on a composite dataset aggregating approximately 6,600 images from the following specific sources:

1. **ORAL DETECTOR (Roboflow Universe)**
   * **Source:** [https://universe.roboflow.com/clients-mpvn2/oral-detector/dataset/3](https://universe.roboflow.com/clients-mpvn2/oral-detector/dataset/3)
   * **Credits:** User `clients-mpvn2` on Roboflow.
   * **Contribution:** Provided 4,131 images covering multiple disease classes (Gingivitis, Calculus, Ulcers, etc.).

2. **Annotated Intraoral Image Dataset for Dental Caries Detection (Zenodo)**
   * **Source:** [https://zenodo.org/records/14827784](https://zenodo.org/records/14827784)
   * **Authors:** Ahmed, Syed Muhammad Faizan; Ghori, Huzaifa; et al.
   * **DOI:** 10.5281/zenodo.14827784
   * **Contribution:** The primary source for the 'Caries' specific data subset.

3. **Healthy Teeth (Roboflow Universe)**
   * **Source:** [https://universe.roboflow.com/sultan-qyobm/healthy-teeth-hgddf/dataset/1](https://universe.roboflow.com/sultan-qyobm/healthy-teeth-hgddf/dataset/1)
   * **Credits:** User `sultan-qyobm` on Roboflow.
   * **Contribution:** Provided 235 healthy control images to prevent false positives.

## Model Outputs
- **Best Model:** `production_models/oral_model_v1_best.pth` - Model with lowest validation loss
- **Periodic Checkpoints:** `production_models/oral_model_v1_epoch_{N}.pth` - Saved every 5 epochs

## Logging & Auditing
The pipeline automatically generates execution logs to track data integrity and training progress:
- `logs/cleaning_log.txt`: Generated by `filter_classes.py`. Tracks class remapping and ghost label removal.
- `logs/build_log.txt`: Generated by `build.py`. Records extraction counts and file origins.
- `logs/dataset_creation_log.txt`: Generated by `create_dataset.py`. Records train/val/test split statistics.
- `logs/training_run_log.txt`: Generated by `train_pytorch.py`. Records training/validation loss, learning rate, and model checkpoints.
- `logs/evaluation_log.txt`: Generated by `evaluate_model.py`. Records test set evaluation metrics.
- `logs/evaluation_results.json`: JSON file containing detailed evaluation metrics (mAP, per-class AP, etc.).

## Disease Classes
The model detects 7 oral disease classes:
1. Caries
2. Gingivitis
3. Tooth Discoloration
4. Ulcer (includes lesions and xerostomia)
5. Calculus
6. Plaque
7. Hypodontia